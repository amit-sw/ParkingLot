<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Drone lander</title>
  <script type="text/javascript">
      url='https://d3yowc8vr7.execute-api.us-east-1.amazonaws.com/Predict/93bd96b5-5c24-4d72-9d05-a04f1998ec33'

      messages={"Safe":"Yay!! The drone is safe!!",
                "NotSafe":"Sorry!! The drone crashed!!"}

      newPoint=[]
      xmax=0
      ymax=0
      predictionCount=0
      
      function drawMain() {
        var canvas = document.getElementById('mainCanvas');
        var img = document.getElementById("parkingImage");
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        xmax=canvas.width
        ymax=canvas.height
        console.log("Xmax=",xmax," Ymax=",ymax)
        newPoint=[xmax-1,ymax-1,xmax,ymax]
      }

      function roundDown(x,y) {
        var a1= x- x%y
        var a2= x - y/2
        if(a2<0) {
          a2=0
        }
        console.log("Rounding down",x," by ",y," to get:",a1," and ",a2)
        return a2
      }

      function drawSecond() {
        var canvas2=document.getElementById('secondCanvas')
        var img2 = document.getElementById("parkingImage");
        var ctx2 = canvas2.getContext('2d');
        var img2size=canvas2.width
        var img2w=canvas2.width
        var img2h=canvas2.height
        var x1=roundDown(newPoint[0],img2w)
        var y1=roundDown(newPoint[1],img2h)
        console.log("Drawsecond picks image section:",x1,y1)
        ctx2.drawImage(img2,x1,y1,img2w,img2h,0,0,img2w,img2h)
        var dataURL = canvas2.toDataURL();
        console.log("New data URL:",dataURL);
        predictImage(dataURL)
      }

      function acceptInput() {
        var canvas = document.getElementById('mainCanvas');
        function getCursorPosition(canvas, event) {
          const rect = canvas.getBoundingClientRect()
          const x = event.clientX - rect.left
          const y = event.clientY - rect.top
          newPoint=[x,y,xmax,ymax]
          console.log("newPoint=",newPoint);
          drawSecond()
          //predict()
          }
        canvas.addEventListener('mousedown', function(e) {
          getCursorPosition(canvas, e)
        })
      }

      function predictImage(dataURL) {
        //let url=' https://d3yowc8vr7.execute-api.us-east-1.amazonaws.com/Predict/3554dfdc-1753-4702-a305-91f7be5ac42b'
        //let url = 'https://q6x4m57367.execute-api.us-east-1.amazonaws.com/Predict/44a35099-a847-4406-84eb-19b35427e4e5'

        let encoded = dataURL.toString().replace(/^data:(.*,)?/, '');
        if ((encoded.length % 4) > 0) {
          encoded += '='.repeat(4 - (encoded.length % 4));
        }
        console.log("\n\nEncoded:",encoded);
        fetch(url, {
          method: 'POST',
          body: encoded
        })
        .then(function(response) {
          console.log('Got response:',response)
          return response.json();
        }).then(function(data) {
          console.log('Got data:',data);
          processPrediction(data['predicted_label'])
        })
        .catch(() => { /* Error. Inform the user */ })
          console.log("Just sent form data non-IE")
        
      }

      function processPrediction(predictedValue) {
        console.log("Processing prediction: ",predictedValue)
        predictionCount = predictionCount + 1
        countPrediction.innerHTML="#"+predictionCount+". "
        valuePrediction.innerHTML=messages[predictedValue]
      }


      function predictText() {
  
        var ENDPOINT = 'https://d3yowc8vr7.execute-api.us-east-1.amazonaws.com/Predict/ca2eb801-eb4f-421b-8a84-e0973127e386';
        var data = `{"x":${newPoint[0]},"y":${newPoint[1]},"xmax":${newPoint[2]},"ymax":${newPoint[3]} }`;
        console.log("\n\n\nEndpoint:",ENDPOINT,"Prediction input: ",data)
        return fetch(ENDPOINT, {
          method: 'POST',
          body: data,
        })
        .then(res => res.json())
        .then(response => JSON.parse(response.body))
        .then(function(data) {
          processPrediction(data)
        })
        .catch(err => console.log('err', err));
      };

      function processPredictionText(data) {
        console.log("processPrediction: ",data)
        var predictedValue=data["predicted_label"]
        valuePrediction.innerHTML=predictedValue
      }

      function uploadData() {
        console.log("Called: uploadData", newPoint)
        predict()
        console.log("Finished: uploadData\n")
      }

	</script>
	<style type="text/css">
		canvas {
			border: 2px solid black;
		}

    .prediction {
      font-size: xx-large;
		}
	</style>
</head>

<body onload="drawMain();acceptInput();">
  <H1>Safely land the Drone</H1>
	<canvas id="mainCanvas" width="600" height="400"></canvas>
  <p> <p>
  <div class="prediction">
  Selected: <canvas id="secondCanvas" width="120" height="80"></canvas><p>
  
     <span id="countPrediction"></span> <span id="valuePrediction"> Waiting for selection</span> 
  </div> 
  </p>
    <img src="/Parking_Lot2.png" id="parkingImage" height="1" width="1">

  
  
</body>

</html>

